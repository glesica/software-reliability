<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>/topics/linters-and-formatters [software reliability]</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <style>
  div.sourceCode, pre.output {
      border: 1px solid gainsboro;
      box-shadow: 3px 3px 10px gainsboro;
      display: block;
      font-size: 0.9rem;
      padding: 1.0rem;
  }

  figure {
      text-align: center;
  }

  figcaption {
      font-size: 0.8rem;
      font-style: italic;
      text-align: center;
  }

  #before {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid black;
  }

  #after {
      display: flex;
      justify-content: space-between;
      border-top: 1px solid black;
  }
  </style>
</head>
<body>
<div id="banner">
    <img src="media/header.jpg" alt="Course Header">
</div>
<div id="before">
    Software Reliability and Testing
    <div id="before-links">
        <a href="../.." title="Course Home">Home</a> |
        <a href="https://github.com/glesica/software-reliability" title="Course GitHub Page">GitHub</a>
    </div>
</div>
<h1 id="linters-and-formatters">Linters and Formatters</h1>
<ul>
<li><a href="assignment/">Homework</a></li>
</ul>
<p>Not all static analysis has to do with types. There are many pitfalls and other undesirable patterns that we can detect in code without actually running it that have little or nothing to do with a type system.</p>
<p>Tools that help us detect problems, or potential problems, in our code are often referred to as “linters” (because they find “lint” in our code, get it?). There are many, many linters in existence, for many different programming languages. We will take a look at a few examples and then write our own linter.</p>
<h2 id="style-and-formatting">Style and Formatting</h2>
<p>You might not think that coding style would be a major concern, but it is. There are a few famous style debates, and hundreds of smaller ones faced by software development teams every day.</p>
<p>Probably the most famous debate has to do with the placement of curly braces in C-like languages. There are a number of different, syntactically valid ways to situation curly braces, and everyone has a favorite.</p>
<p>Some of the possible curly brace styles for conditionals are shown below. Note, however, that functions are often treated differently, which creates a combinatorial explosion of possible styles. Which do you prefer?</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// K&amp;R</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(...)</span> <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Allman</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(...)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">// GNU</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(...)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Horstmann</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(...)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>   <span class="op">...</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Whitesmiths</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(...)</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>Clearly, programmers have always had a lot of free time on their hands. However, we still need to get work done (eventually). For this reason, it is generally considered a good idea for a team to decide how the code for a project should work and enforce those decisions automatically… with linters.</p>
<p>There are other, less controversial, examples. Single-letter variable names are often considered bad style, as are variable names that do not conform to the conventions of the language in use (more on this later). It is also widely viewed as good style to include documentation at the beginning of each class and function.</p>
<p>All of these choices, and more, can be enforced with linters, which can save a team a lot of time and energy to put toward building great software.</p>
<p>TODO</p>
<h2 id="practices">Practices</h2>
<p>We can also use linters to enforce good programming practices. This can help prevent bugs before they happen, improve performance, and enforce security practices.</p>
<p>TODO</p>
<h2 id="examples">Examples</h2>
<p>Below is a collection of well-known linters and formatters for various languages, along with simple usage examples and recommendations.</p>
<h3 id="black-python">Black (Python)</h3>
<ul>
<li><a href="https://github.com/psf/black">GitHub</a></li>
<li><a href="https://black.readthedocs.io/en/stable/">Documentation</a></li>
</ul>
<p>Black is a formatter for Python. It can be configured based on the preferences of the user and it can automatically modify code so that it is correctly formatted.</p>
<h3 id="clippy-rust">Clippy (Rust)</h3>
<ul>
<li><a href="https://github.com/rust-lang/rust-clippy">GitHub</a></li>
<li><a href="https://rust-lang.github.io/rust-clippy/stable/index.html">Lints</a></li>
</ul>
<p>TODO</p>
<h3 id="hlint-haskell">HLint (Haskell)</h3>
<ul>
<li><a href="https://github.com/ndmitchell/hlint">GitHub</a></li>
</ul>
<p>TODO</p>
<h3 id="pylint-python">Pylint (Python)</h3>
<ul>
<li><a href="https://github.com/PyCQA/pylint">GitHub</a></li>
<li><a href="https://pylint.pycqa.org/en/latest/">Documentation</a></li>
</ul>
<p>TODO</p>
<h3 id="rustfmt">Rustfmt</h3>
<ul>
<li><a href="https://github.com/rust-lang/rustfmt">GitHub</a></li>
<li><a href="https://rust-lang.github.io/rustfmt/">Documentation</a></li>
</ul>
<h2 id="a-linter-from-scratch">A Linter From Scratch</h2>
<p>We’re going to write a linter from scratch to see how they work and get some practice working with the concepts central to static analyzers in general. Our linter isn’t going to do much, it will run on a Python file and identify any classes that do not have <code>CamelCase</code> names and functions that do not have <code>snake_case</code> names.</p>
<h3 id="define-cases">Define Cases</h3>
<p>First, we need to decide how to tell if a name is cased correctly. We could probably come up with all kinds of clever heuristics, but we will keep it simple and say that any name that starts with a capital letter and does not contain any underscores (<code>_</code>) is in proper camel case. We will assume that any name that consists only of lowercase letters and underscores is in proper snake case.</p>
<p>We can codify these definitions with code. We will use the following function to determine whether a name is in camel case:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _is_camel(value: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&quot;_&quot;</span> <span class="kw">in</span> value:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value[<span class="dv">0</span>].upper() <span class="op">!=</span> value[<span class="dv">0</span>]:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span></code></pre></div>
<p>The following function will tell us if a name is in snake case:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _is_snake(value: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> value.lower() <span class="op">!=</span> value:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span></code></pre></div>
<h3 id="visitor-pattern">Visitor Pattern</h3>
<p>Before we go further, we need to take a little detour.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Visitor_pattern">visitor pattern</a> is a way to add additional functionality to a group of related classes. It is often used to process trees and other nested data structures. Since, as the name suggests, the Abstract Syntax Tree (AST) produced by a parser for a programming language is such a data structure, we can use a visitor to process the AST and identify mis-named classes and functions.</p>
<p>First, we will take a look at a simple visitor example using a tree that consists of two kinds of vertices. We will refer to an interior vertex (that is, on that has children) as a “node”, and a leaf vertex (one without children) as a “leaf”.</p>
<p>A simple tree, where each leaf stores a single integer, might look like the one in the diagram below.</p>
<figure>
<img src="sample.png" alt="Sample Tree Diagram" /><figcaption aria-hidden="true">Sample Tree Diagram</figcaption>
</figure>
<p>We can define some classes to represent this tree. A <code>Node</code> represents an interior node in the tree and a <code>Leaf</code> represents a leaf. The leaf node can store data (as in the diagram above).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Node:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name, <span class="op">*</span>children):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.children <span class="op">=</span> children</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Leaf:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data):</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data <span class="op">=</span> data</span></code></pre></div>
<p>We can construct the tree in the diagram above like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>tree <span class="op">=</span> Node(<span class="st">&quot;A&quot;</span>,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    Leaf(<span class="dv">7</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    Node(<span class="st">&quot;B&quot;</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        Leaf(<span class="dv">4</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        Leaf(<span class="dv">5</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        Leaf(<span class="dv">2</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s sum the values stored in the leaf nodes. This is simple to do using a graph traversal, but we can also use a visitor to get the same effect. We will implement a standard traversal, followed by a visitor for comparison.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sum_leaves(tree):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">type</span>(tree) <span class="kw">is</span> Node:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> tree.children:</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            total <span class="op">+=</span> sum_leaves(child)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> total</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">type</span>(tree) <span class="kw">is</span> Leaf:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> tree.data</span></code></pre></div>
<p>There is nothing wrong with the code above, but if we had many different kinds of vertices it might get tedious to implement several operations this way. One way to simplify things is to use a visitor.</p>
<p>First, we define a base class that abstracts out the traversal behavior. When a node is visited, the visitor proceeds to visit all of its children. When a leaf is visited, the visitor does nothing (since there isn’t anything obvious to do). This breakdown of the tree by types lies at the heart of the visitor pattern. It allows us to focus on the class instances (vertices, in this case) that interest us, and ignore the ones that don’t. A visitor base class like this would generally be provided by the library that provides the classes it is used with.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Visitor:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit(tree):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">type</span>(tree) <span class="kw">is</span> Node:</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.visit_node(tree)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">type</span>(tree) <span class="kw">is</span> Leaf:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.visit_leaf(tree)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit_node(node):</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> node.children:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.visit(child)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit_leaf(leaf):</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div>
<p>We can now implement our summation algorithm as a “summing” visitor. Since this visitor extends the base class, it can ignore the nodes entirely and focus on the leaves, since they store the values to be summed.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SummingVisitor(Visitor):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit_leaf(leaf):</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.total <span class="op">+=</span> leaf.data</span></code></pre></div>
<p>We can now use our class like so, reading the sum from the <code>total</code> field after it has finished:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>visitor <span class="op">=</span> SummingVisitor()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>visitor.visit(tree)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(visitor.total)</span></code></pre></div>
<p>The Visitor Pattern is widely used for processing and manipulating ASTs. The Python <code>ast</code> module is no exception, as we will see.</p>
<h3 id="case-visitor">Case Visitor</h3>
<p>The actual visitor implementation is shown below. Visitor methods are implemented using runtime reflection, the base class looks for a method called <code>visit_X</code> where <code>X</code> is the class name of the node to be processed. If such a method is not found, a generic method, on the base class, is run instead.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CaseVisitor(ast.NodeVisitor):</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.errors <span class="op">=</span> []</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit_ClassDef(<span class="va">self</span>, node: ast.ClassDef):</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> _is_camel(node.name):</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.errors.append(<span class="ss">f&quot;class </span><span class="sc">{</span>node<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> should be CamelCase&quot;</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">super</span>().generic_visit(node)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> visit_FunctionDef(<span class="va">self</span>, node: ast.FunctionDef):</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> _is_snake(node.name):</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.errors.append(<span class="ss">f&quot;function </span><span class="sc">{</span>node<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> should be snake_case&quot;</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">super</span>().generic_visit(node)</span></code></pre></div>
<p>We need to “visit” two kinds of AST node: class definitions and function (and method) definitions. In both cases, we simply check to see whether the name follows the rules we established earlier and encoded in the <code>_is_camel</code> and <code>_is_snake</code> functions, and add an error if not.</p>
<h3 id="application">Application</h3>
<p>We use the visitor class we defined above in a function called <code>check_file</code>. This function accepts a Python source code file, parses it, and applies the visitor. It returns the error messages collected by the visitor.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_file(src: TextIO) <span class="op">-&gt;</span> Iterable[<span class="bu">str</span>]:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    code <span class="op">=</span> src.read()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> ast.parse(code)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    case_visitor <span class="op">=</span> CaseVisitor()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    case_visitor.visit(tree)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> case_visitor.errors</span></code></pre></div>
<p>The rest of the application just opens the file passed on the command line, and calls the <code>check_file</code> function. It prints the error messages, if there are any, and sets the exit code accordingly.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> sys</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(path, <span class="st">&quot;r&quot;</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        errors <span class="op">=</span> check_file(<span class="bu">file</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    exit_code <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> error <span class="kw">in</span> errors:</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        exit_code <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    sys.exit(exit_code)</span></code></pre></div>
<p>See <a href="caselinter.py">caselinter.py</a> for the full source code in one place.</p>
<h3 id="running">Running</h3>
<p>We can run out linter against its own code quite easily.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> caselinter.py</span></code></pre></div>
<p>Of course, because the AST visitor used some strange method names, we get errors!</p>
<pre class="output"><code>caselinter.py: function visit_ClassDef should be snake_case
caselinter.py: function visit_FunctionDef should be snake_case</code></pre>
<p>Since we can’t “fix” these method names (they are relied upon by the <code>ast</code> module) we could add a way to ignore those names. This is quite common. One option would be to look for a special comment like <code># caselinter: ignore</code> and skip the following line. This is left as an exercise for the reader.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Linters help us enforce standards on our code. This can result in more harmonious teams but, more importantly, it helps us produce readable, maintainable code. Given that human error is the cause of virtually all software bugs, making our code easier to read and maintain is a worthwhile goal.</p>
<p>Harold Abelson, one of the authors of the famous programming text <em>Structure and Interpretation of Computer Programs</em>, which is sort of the OG software engineering book, said it best:</p>
<blockquote>
<p>Programs must be written for people to read, and only incidentally for machines to execute.</p>
</blockquote>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li>rust-code-analysis: a Rust library to analyze and extract maintainability information from source code - <a href="https://doi.org/10.1016/j.softx.2020.100635">DOI</a></li>
<li>Tree Sitter: a multi-language parsing library - <a href="https://tree-sitter.github.io/tree-sitter/">Web</a></li>
</ul>

<div id="after">
    <a href="#">Back to top</a>
    <div id="after-links">
        <a href="../.." title="Course Home">Home</a> |
        <a href="https://github.com/glesica/software-reliability" title="Course GitHub Page">GitHub</a>
    </div>
</div>
</body>
</html>
